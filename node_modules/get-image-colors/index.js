const getPixels = require('get-pixels')
const getRgbaPalette = require('get-rgba-palette')
const chroma = require('chroma-js')
const getSvgColors = require('get-svg-colors')
const pify = require('pify')

const patterns = {
  image: /\.(gif|jpg|png|svg)$/i,
  raster: /\.(gif|jpg|png)$/i,
  svg: /svg$/i
}

//added a count to the options
function colorPalette (input, options, callback) {
  if (typeof options === 'function') {
    callback = options
    options = {
      type: undefined,
      count: 5
    }
  } else if (typeof options === 'string') {
    options = {
      type: options,
      count: 5
    }
  }

  // SVG
  if (!Buffer.isBuffer(input)) {
    if (input.match(patterns.svg)) {
      return callback(null, getSvgColors(input, { flat: true }))
    }
  } else if (options.type === 'image/svg+xml') {
    return callback(null, getSvgColors(input, { flat: true }))
  }

  // PNG, GIF, JPG
  return paletteFromBitmap(input, options, callback)
}

function paletteFromBitmap (filename, options, callback) {
  if (!callback) {
    callback = options
    options = {
      type: undefined,
      count: 5 // not sure if I should change that? I won't be using bitmap anytime soon
    }
  }

  // ---> the options.type was replaced with "image/png"
  getPixels(filename, options.type, function (err, pixels) {
    // issues is in getpixels
    if (err) {
      //console.log("error from get-image-colors: " + err.message);
      return callback(err);
    }
    // hard code in the 1 to make sure that we get the number we are looking for
    const palette = getRgbaPalette(pixels.data, options.count).map(function (rgba) {
      return chroma(rgba)
    })

    return callback(null, palette)
  })
}

module.exports = pify(colorPalette)
